{% extends "./plantilla.html" %}
{% block body %}
<br>

<div class="container">
    <h1>Gestión de Películas con Peticiones Asíncronas</h1>
    <div class="row">
        <div class="col-md-12 text-end">
            <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
                <i class="fas fa-plus"></i>
                <b>Agregar Película</b>
            </a>
        </div>
    </div>
</div>

<br>

<table class="table table-bordered table-striped table-hover" id="tbl-peliculas">
    <thead>
        <tr>
            <th class="text-center">ID</th>
            <th class="text-center">Título</th>
            <th class="text-center">Duración</th>
            <th class="text-center">Sinopsis</th>
            <th class="text-center">Género</th>
            <th class="text-center">Director</th>
            <th class="text-center">Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for pelicula in peliculas %}
        <tr>
            <td class="text-center">{{ pelicula.id }}</td>
            <td class="text-center">{{ pelicula.titulo }}</td>
            <td class="text-center">{{ pelicula.duracion }}</td>
            <td class="text-center">{{ pelicula.sinopsis }}</td>
            <td class="text-center">{{ pelicula.genero.nombre }}</td>
            <td class="text-center">{{ pelicula.director.nombre }}</td>
            <td class="text-center">
                <button class="btn btn-outline-warning btn-circle" title="Editar Película" onclick="mostrarFormularioEditar({{ pelicula.id }})">
                    <i class="fas fa-pencil"></i>
                </button>
                <button class="btn btn-outline-danger btn-circle" title="Eliminar Película" onclick="eliminarPelicula({{ pelicula.id }})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    var table = new DataTable('#tbl-peliculas');

    // Función para mostrar el formulario de edición
    function mostrarFormularioEditar(id) {
        fetch(`/editarPelicula/${id}/`)
            .then(response => response.text())
            .then(html => {
                document.querySelector('#exampleModal .modal-content').innerHTML = html;
                var modal = new bootstrap.Modal(document.getElementById('exampleModal'));
                modal.show();
            })
            .catch(error => console.error('Error al cargar el formulario de edición:', error));
    }

    // Función para eliminar una película
    function eliminarPelicula(id) {
        if (confirm('¿Estás seguro de eliminar esta película?')) {
            fetch(`/eliminarPelicula/${id}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.estado) {
                    alert(data.mensaje);
                    location.reload();
                } else {
                    alert(data.mensaje);
                }
            })
            .catch(error => console.error('Error al eliminar la película:', error));
        }
    }

    // Función para guardar una nueva película
    document.querySelector('#frm_nueva_pelicula').addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(this);

        fetch('{% url "guardarPelicula" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.estado) {
                alert(data.mensaje);
                location.reload();
            } else {
                alert(data.mensaje);
            }
        })
        .catch(error => console.error('Error al guardar la película:', error));
    });
</script>

<style>
    .btn-circle {
        border-radius: 100px !important;
    }
</style>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Nueva Película</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{% url 'guardarPelicula' %}" method="POST" id="frm_nueva_pelicula">
                    {% csrf_token %}
                    <label for="titulo"><b>Título:</b></label>
                    <input type="text" name="titulo" class="form-control" id="titulo" placeholder="Ingrese el título de la película" required>
                    <br>
                    <label for="duracion"><b>Duración:</b></label>
                    <input type="text" name="duracion" class="form-control" id="duracion" placeholder="Ingrese la duración de la película" required>
                    <br>
                    <label for="sinopsis"><b>Sinopsis:</b></label>
                    <textarea name="sinopsis" class="form-control" id="sinopsis" placeholder="Ingrese la sinopsis de la película" required></textarea>
                    <br>
                    <label for="genero"><b>Género:</b></label>
                    <select name="genero" class="form-control" id="genero" required>
                        <option value="">Seleccione un género</option>
                        {% for genero in generos %}
                            <option value="{{ genero.id }}">{{ genero.nombre }}</option>
                        {% endfor %}
                    </select>
                    <br>
                    <label for="director"><b>Director:</b></label>
                    <select name="director" class="form-control" id="director" required>
                        <option value="">Seleccione un director</option>
                        {% for director in directores %}
                            <option value="{{ director.id }}">{{ director.nombre }}</option>
                        {% endfor %}
                    </select>
                    <br>
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>&nbsp;Guardar
                        </button>
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i>&nbsp;Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}
